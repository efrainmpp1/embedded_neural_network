#include "math.h"

#define n0 0b11111010
#define n_1 0b01100000
#define n_2 0b11011100
#define n3 0b11110100
#define n4 0b01100110
#define n5 0b10110110
#define n6 0b10111110
#define n7 0b11100000
#define n8 0b11111110
#define n9 0b11110110

// Arquivo contendo os x para teste da rede
const float x_test[20][7] ={{2.50198930213149,0.439350927051998,2.48548207218913,4.46270844985632,0.437979299603599,2.97579370472236,2.42779734998041},
    {0.224953481291687,0.0591578948752182,0.602966424751168,0.273830529503537,3.02499171823299,2.70892869288254,3.53893831450574},
    {3.34128041389553,0.602692721115502,0.400020475964477,3.82931560737046,3.5671074849897,3.12630353213998,4.73393711196318},
    {2.17655192482015,2.16399848513121,2.60762397175183,2.49228652561193,3.00951002038675,2.10301006956172,4.51720992431126},
    {0.559720280523962,0.36634434746801,0.724544629977762,0.641010440082402,2.31952070757989,2.23330185414082,3.00043385888996},
    {4.27315781515812,4.53206991247133,0.0315961818645098,0.597319924344235,4.1599374900641,3.3087954121267,0.571502003659656},
    {0.772498513516504,4.64595940234057,2.61938414458311,3.75385664047026,2.83013067531399,4.90494814651418,4.6628364149798},
    {0.525645141056299,0.0865338019091946,0.296863857788462,0.303153270370191,3.99470667997045,2.21548681597094,4.49797197525578},
    {4.13369298478893,0.168581931318442,4.62149171535962,2.33383514455161,0.711017560143584,2.519789691746,4.68489968094694},
    {4.45758528479096,0.435873623714479,0.510769428565862,4.62180875413646,3.54083387504983,2.4914252650134,3.28326694687096},
    {0.111697967631273,0.18664601652709,0.457987755263476,0.155734881737423,2.68095654299123,4.42663727065873,0.674601673214305},
    {2.31824541440919,2.15815817197502,3.18040876552552,4.57606458247427,4.31062251778083,4.06848355882073,4.08636788069978},
    {3.14309995813978,2.08915376025929,0.105853631699198,2.96214359549629,2.00649684516174,0.633501822970257,2.14723265908287},
    {3.63737146903211,0.66990344768261,3.51424682224282,2.88455508374377,0.764528037627004,4.9859744200611,4.09216941499024},
    {4.57552818944141,3.59411144932426,2.11621741716333,2.46186997441944,2.99463198936035,0.732412402698918,3.7944437160024},
    {0.619822445397708,3.65536186947519,2.6423169631029,4.29201571651065,3.30768813412371,4.39854630031618,3.67164091499147},
    {0.445872996791149,0.797314425683529,0.372553984435192,0.20824261678695,3.76249460551332,4.83838573472458,3.60834184721916},
    {4.78498132650623,3.76924764436192,0.0749942498949683,0.0826228804037309,4.31682937596116,2.27120655617457,0.18689067065253},
    {0.158693338328967,0.621028093680959,0.712279702805498,0.533141114558088,3.8967233446694,2.49544114357526,0.0534782171488906},
    {0.146862974491457,2.93679211360063,2.47835776385553,2.21417662521272,3.17103345797033,4.46866132131242,4.50674030669954}
};

const float dense_1[7][20] = {{ 0.4924856 , -0.34734434, -0.1432838 ,  0.22066599, -0.28985077,
         0.1853532 ,  0.7791384 , -0.4391016 ,  0.89725035,  0.29646608,
         0.09468751,  1.1293534 ,  0.25327867, -0.08376442,  0.08684145,
         0.64933026,  0.39398563, -0.2799999 ,  0.9132224 ,  0.08747188},
       { 0.5387783 , -0.5612029 , -0.20713316,  0.35602775, -0.3598068 ,
        -0.02412539, -0.25785872,  0.01207616,  0.17104065, -0.6655473 ,
        -1.7251682 ,  0.7548438 , -0.27954945, -0.22095658, -0.45951545,
         0.40600947, -0.62969756, -1.0167687 ,  0.31216356, -0.46161234},
       {-0.19070235,  0.28153622, -0.36316848,  1.3461049 , -0.18752366,
        -1.2612185 ,  0.05567536, -0.4710762 , -0.37603942,  1.003469  ,
        -0.41621244,  0.5724588 ,  0.26376024,  0.67264235,  0.17065364,
         0.5508963 , -0.40388653, -0.01858919, -0.1522535 , -1.3363976 },
       {-0.1967552 ,  0.48684576,  0.1004815 , -0.30933723, -0.96648586,
         0.2755704 ,  0.5947537 , -0.35054833,  0.07923663,  0.11155103,
         0.10533803,  1.3046224 ,  0.7865963 ,  0.35950556, -0.57965875,
         0.6884653 ,  0.02009549,  0.36468494,  0.4392244 ,  0.7293754 },
       { 0.16419457, -0.19042064,  0.21537778, -0.32606572, -0.10556781,
        -0.10812703, -0.24090062, -0.61930674,  0.49684435, -0.2801599 ,
        -0.20786338,  0.15591241,  0.05431829, -0.53750634,  0.1548014 ,
         0.60962176, -0.00188829, -0.01108666, -0.41863552,  0.31600457},
       {-1.0401149 ,  0.9879047 , -0.64307415,  0.09524976,  0.6421932 ,
        -0.41605574, -0.57781744, -0.03978971, -0.51609504,  0.12448929,
         0.5455012 ,  0.01398112, -0.5939253 , -0.73157537, -0.5893023 ,
         0.15078372, -0.6028084 ,  0.36937135, -0.04815133, -0.301961  },
       {-0.49187753,  0.05790028,  0.4929211 , -0.3872425 ,  0.08683466,
         0.2943482 ,  0.2637266 , -0.16568847, -0.01754458,  0.3389223 ,
         0.41058567, -1.3577443 ,  0.3319039 ,  0.03093093, -0.58323765,
         0.21655276,  0.7434113 , -0.0780712 ,  1.1608596 , -0.18314666}};


const float bias_1[20] = { 0.5426518 , -0.5710971 ,  0.7182064 , -0.5763889 ,  0.46657553,
       -0.11638038, -0.25019428, -0.27967077, -0.8768818 , -0.6694697 ,
        0.2589249 ,  0.02343099, -0.08101297,  0.37703973, -0.25057524,
        0.2934195 ,  0.9478526 ,  0.44072962, -0.38313928,  0.31427974
};

const float dense_2[20][4] = {{-0.69077104,  1.773658  ,  0.828419  , -0.06544943},
       { 0.9070241 , -1.6854866 , -0.64278   ,  0.16276392},
       {-0.71405244,  1.1288891 ,  0.63867223,  1.3820732 },
       { 0.0937591 , -0.21929407,  0.3000053 , -1.6875299 },
       {-0.27802926,  0.8216333 ,  0.3357861 ,  1.3054159 },
       { 0.35624593, -0.30638668, -0.9999578 ,  1.6866372 },
       { 1.1148678 , -0.91671455, -0.40913105, -0.7595737 },
       { 1.1352524 , -0.15395953,  0.11256454,  0.16395724},
       { 1.47811   ,  0.2629732 ,  0.14091803, -0.06718907},
       { 1.1882615 , -1.0449361 ,  0.99612415, -0.83863676},
       {-0.2340578 , -0.19919541,  1.7966067 ,  1.3125973 },
       {-0.59410775, -1.7024419 , -1.1693045 ,  0.05578813},
       { 0.35677952, -1.2083241 ,  0.70781887,  0.28977945},
       {-1.13264   ,  0.456239  ,  1.6811688 , -1.5001847 },
       { 1.2671545 , -0.3144248 , -0.48566663, -0.73595893},
       {-0.74230033,  0.48060405, -0.08306881,  0.4736899 },
       {-0.5527768 ,  1.2781949 ,  1.5151656 ,  1.0281869 },
       {-0.685642  , -1.1484126 ,  0.7521528 ,  0.5848997 },
       {-0.9336258 ,  1.7422773 ,  0.06153109, -0.48801982},
       { 0.2848997 , -0.8333633 , -0.77097946,  1.2104795 }};

const float bias_2[4] = { -0.7757017 ,  0.44857588, -0.02245325,  0.34211272 };

// predict number
int predict(float m1 , float m2 , float m3 , float m4, float m5 , float m6 , float m7){
  //Serial.begin(9600);
  float input[7] = {m1,m2,m3,m4,m5,m6,m7};

  float n1[20] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
  float n2[4] = {0,0,0,0};

  //dense1
  for(int i=0;i<7;i++){
    for(int j=0;j<20;j++){
      if(dense_1[i][j] != 0. ){
        n1[j] += input[i]*dense_1[i][j];
      }
    }
  }

  //bias1
  for(int i=0;i<20;i++){
    if(bias_1[i]!=0.)
      n1[i]+=bias_1[i];
  }

    //tanh
    for(int i=0;i<7;i++){
        n1[i] = tanh(n1[i]);
    }

  //dense2
  for(int i=0;i<20;i++){
    for(int j=0;j<4;j++){
      if(dense_2[i][j] != 0. ){
        n2[j] += n1[i]*dense_2[i][j];
      }
    }
  }

  //bias2
  for(int i=0;i<4;i++){
    if(bias_1[i]!=0.)
      n2[i]+=bias_2[i];
  }

  //sigmoid
  float p1 = (1 / (1 + exp(-n2[0])));
  float p2 = (1 / (1 + exp(-n2[1])));
  float p3 = (1 / (1 + exp(-n2[2])));
  float p4 = (1 / (1 + exp(-n2[3])));

  //arredonda os resultados para ficar 0 ou 1 
  int dig1 = roundf(p1);
  int dig2 = roundf(p2);
  int dig3 = roundf(p3);
  int dig4 = roundf(p4);
  
  return 8*dig1 + 4 * dig2 + 2 * dig3 + 1*dig4;
          
}


int main(){

  //Serial.begin(9600);
  
  
  DDRD |= 0b11111111;
  PORTD = 0b00000000; 
  DDRB |= 0b00000001;
  PORTB = 0b00000000; 
  
  int i =0;
  
  while(1){
    
    if(i>19){
    	i = 0;
    }
    float g = x_test[i][0];
    float f = x_test[i][1];
    float e = x_test[i][2];
    float d = x_test[i][3];
    float c = x_test[i][4];
    float b = x_test[i][5];
    float a = x_test[i][6];
    
    int num = predict(g,f,e,d,c,b,a);
    
    switch (num)
    {
      case 0:
        PORTD = n0 ; 
 
        break;
      case 1:
        PORTD = n_1;

        break;
      case 2:
         
        PORTD = n_2;

        break;
      case 3:
         
        PORTD = n3;

        break;
      case 4:
         
        PORTD = n4;
		    PORTB = 0b00000001;
        break;
      case 5:
         
        PORTD = n5;
		    PORTB = 0b00000001;
        break;
      case 6:
         
        PORTD = n6;
		PORTB = 0b00000001;
        break;
      case 7:
         
        PORTD = n7;

        break;
      case 8:
         
        PORTD = n8;
		PORTB = 0b00000001;
        break;
      case 9:
        
        PORTD = n9;
      	PORTB = 0b00000001;
        break;

      default:
        break;
    }
    
  	_delay_ms(1000);
    PORTD &= 0b00000000; //apaga todos os leds da porta D
    PORTB &= 0b00000000; //apaga todos os leds da porta B
    i+=1;
  	_delay_ms(1000);
  }
}